<script type="text/javascript">
    RED.nodes.registerType('victron-dynamic-ess', {
        category: 'Victron Energy',
        paletteLabel: 'VRM dynamic ESS',
        color: '#f7ab3e',
        defaults: {
            name: { value: "" },
            vrmtoken: { value: "", validate: RED.validators.regex(/^[a-z0-9]{64}$/) },
            site_id: { value: "", validate: RED.validators.number() },
            country: { value: "", validate: RED.validators.regex(/^[a-z]{2}$/) },
            b_max: { value: 10, validate: RED.validators.number() },
            fb_max: { value: 1.1, validate: RED.validators.number() },
            tb_max: { value: 1.2, validate: RED.validators.number() },
            fg_max: { value: 1.0, validate: RED.validators.number() },
            tg_max: { value: 1.0, validate: RED.validators.number() },
            b_cost: { value: 0.0, validate: RED.validators.number() },
            provider_fee: { value: 0.0, validate: RED.validators.number() },
            vat_percentage: { value: 0.0, validate: RED.validators.regex(/^\d{0,99}$/) },
            feed_in_possible: { value: true },
            feed_in_control_on: { value: true },
            verbose: { value: true }
        },
        inputs: 1,
        outputs: 4,
        icon: "victronenergy.svg",
        label: function () {
            return this.name || "Dynamic ESS";
        }
    });
</script>

<script type="text/html" data-template-name="victron-dynamic-ess">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-vrmtoken"><i class="fa fa-user-secret"></i> VRM token</label>
        <input type="password" id="node-input-vrmtoken" placeholder="VRM token" required>
    </div>
    <div class="form-row">
        <label for="node-input-site_id"><i class="fa fa-id-card"></i> VRM site id</label>
        <input type="text" id="node-input-site_id" placeholder="VRM site id" required>
    </div>
    <div class="form-row">
        <label for="node-input-country"><i class="fa fa-location-arrow"></i> Country</label>
        <select id="node-input-country" required>
            <option value="al">Albania (al)</option>
            <option value="at">Austria (at)</option>
            <option value="be">Belgium (be)</option>
            <option value="ba">Bosnia and Herz. (ba)</option>
            <option value="bg">Bulgaria (bg)</option>
            <option value="hr">Croatia (hr)</option>
            <option value="cy">Cyprus (cy)</option>
            <option value="cz">Czech Republic (cz)</option>
            <option value="dk">Denmark (dk)</option>
            <option value="ee">Estonia (ee)</option>
            <option value="fi">Finland (fi)</option>
            <option value="fr">France (fr)</option>
            <option value="ge">Georgia (ge)</option>
            <option value="de">Germany (de)</option>
            <option value="gr">Greece (gr)</option>
            <option value="hu">Hungary (hu)</option>
            <option value="ie">Ireland (ie)</option>
            <option value="it">Italy (it)</option>
            <option value="xk">Kosovo (xk)</option>
            <option value="lv">Latvia (lv)</option>
            <option value="lt">Lithuania (lt)</option>
            <option value="lu">Luxembourg (lu)</option>
            <option value="mt">Malta (mt)</option>
            <option value="md">Moldova (md)</option>
            <option value="me">Montenegro (me)</option>
            <option value="nl">Netherlands (nl)</option>
            <option value="mk">North Macedonia (mk)</option>
            <option value="no">Norway (no)</option>
            <option value="pl">Poland (pl)</option>
            <option value="pt">Portugal (pt)</option>
            <option value="ro">Romania (ro)</option>
            <option value="rs">Serbia (rs)</option>
            <option value="sk">Slovakia (sk)</option>
            <option value="si">Slovenia (si)</option>
            <option value="es">Spain (es)</option>
            <option value="se">Sweden (se)</option>
            <option value="ch">Switzerland (ch)</option>
            <option value="tr">Turkey (tr)</option>
            <option value="ua">Ukraine (ua)</option>
            <option value="uk">United Kingdom (uk)</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-b_max"><i class="fa fa-battery-full"></i> B max</label>
        <input type="text" id="node-input-b_max" placeholder="Usable battery capacity (kWh)">
    </div>
    <div class="form-row">
        <label for="node-input-tb_max"><i class="fa fa-battery-full"></i> TB max</label>
        <input type="text" id="node-input-tb_max" placeholder="Amount the battery charges in one hour (kW)">
    </div>
    <div class="form-row">
        <label for="node-input-fb_max"><i class="fa fa-battery-full"></i> FB max</label>
        <input type="text" id="node-input-fb_max" placeholder="Amount the battery discharges in one hour (kW)">
    </div>
    <div class="form-row">
        <label for="node-input-tg_max"><i class="fa fa-battery-full"></i> TG max</label>
        <input type="text" id="node-input-tg_max" placeholder="Amount the grid can receive (to grid) in one hour (kW)">
    </div>
    <div class="form-row">
        <label for="node-input-fg_max"><i class="fa fa-battery-full"></i> FG max</label>
        <input type="text" id="node-input-fg_max" placeholder="Amount the grid can provide (from grid) in one hour (kW)">
    </div>
    <div class="form-row">
        <label for="node-input-b_cost"><i class="fa fa-money"></i> Battery costs</label>
        <input type="text" id="node-input-b_cost" placeholder="Battery costs">
    </div>
    <div class="form-row">
        <label for="node-input-provider_fee"><i class="fa fa-balance-scale"></i> Price offset</label>
        <input type="text" id="node-input-provider_fee" placeholder="The provider fee of buy/sell prices for the grid">
    </div>
    <div class="form-row">
        <label for="node-input-vat_percentage"><i class="fa fa-plus-circle"></i> VAT percentage</label>
        <input type="number" id="node-input-vat_percentage" min="0" max="99" placeholder="The VAT percentage (eg. 21%)">
    </div>
    <div class="form-row">
        <label style="min-width:390px" for="node-input-feed_in_possible"><i class="fa fa-power"></i> Feed in possible: Can you sell back to the grid?</label>
        <input type="checkbox" checked id="node-input-feed_in_possible" style="max-width:30px">
    </div>
    <div class="form-row">
        <label style="min-width:390px" for="node-input-feed_in_control_on"><i class="fa fa-power"></i> Feed-in control: Allow control over the feed-in variable (turn it off automatically when the prices are negative)?</label>
        <input type="checkbox" checked id="node-input-feed_in_control_on" style="max-width:30px">
    </div>
    <div class="form-row">
        <label style="min-width:390px" for="node-input-verbose"><i class="fa fa-power"></i> Verbose: show the used <tt>curl</tt> command in the debug tab?</label>
        <input type="checkbox" checked id="node-input-verbose" style="max-width:30px">
    </div>
</script>

<script type="text/html" data-help-name="victron-dynamic-ess">
    <p>The <i>dynamic ess</i> node is for users that have an energy storage system (ESS)
    in combination with a solar system and want to set it automatically to the
    optimal value. Where optimal means that it is set so you will pay the least
    amount for your energy usage.  There are several factors determining the
    optimal value, all being taken into account. These factors are:</p>

    <ul>
        <li>the VRM id</li>
        <li>the solar prediction</li>
        <li>your (dynamic) energy contract price</li>
        <li>your battery size</li>
        <li>the charge speed of your battery</li>
        <li>the discharge speed of your battery</li>
        <li>your predicted consumption</li>
    </ul>

    <p>
        If all of these values are known, VRM can make a calculated optimum setpoint available
        via its application programming interface (API). The <i>dynamic ess</i> node
        utilizes that API to fetch it in a userfriendly way.  Where optimum means the
       setting that should result in the lowest energy costs.
    </p>

    <p>
        Some of the information is deducted from set parameters. Like the country determines
        the energy price (as retrieved from ENTSOE). The location that has been set for the site
        in VRM is used for determining the predicted solar forecast. It uses solcast and the Global
        Horizontal Irradiance (GHI) for getting the predicted solar yield. So it is important
        to set the location correctly in VRM (<i>Settings -> Set location</i>).
    </p>

    <p>
        More info can be found on the <a href="https://github.com/victronenergy/dynamic-ess">github</a> site for this node.
    </p>

  <h3>Configuration</h3>

  <p>In order to function, the <em>VRM site id</em> of the system needs to be
  given. The node can only access the information if also a <em>VRM token</em>
  has been set. This is the number that is found in the url of the VRM dashboard.</p>

  <p>
    Also several other configuration fields need to be filled out.
  </p>

<p>For calculating with the correct tarrif of the energy supplier, the buy and sell
    price formula needs to be filled out. The variable <tt>p</tt> can be used to
   in the formula to represent the dynamic tarrif.
</p>

<p>If the <em>verbose</em> checkbox has been set, the node becomes a bit
    more verbose and sends out some extra debugging information.</p>

    <p>The <i>Allow disable feed-in</i> checkbox is to allow the system to disable
        grid feed-in when the energy prices are negative.</p>

  <h3>Input</h3>

  <p>Whenever the input receives a value, the new setpoint is fetched from
  VRM. A repeating inject node (interval 5 minutes) is recommended.
  More often has no use as the ideal setpoint only gets calculated that often
  on VRM.</p>

  <p>
    Overruling the configured settings of the node can be done by injecting one 
    or more of the following values:
  </p>

  <ul>
  <li><tt>msg.site_id</tt> - The vrm id to fetch the data for. This is the unique number of the site and can be found in the url of the VRM dashboard.</li>
  <li><tt>msg.country</tt> - The country code that is used for determining the hourly
tarrif of the energy.</li>. See the dropdown in the select for the two-letter value
to use.
  <li><tt>msg.b_max</tt> - This is the
  capacity the battery can hold in kWh. Defaults to <em>10</em>> kWh.</li>
  <li><tt>msg.tb_max</tt> - This is the
  speed in kW that the battery can be charged at in an hour (to battery). Defaults
  to <em>1</em> kW.</li>
  <li><tt>msg.fb_max</tt> -  This is the
  speed in kW that the battery can be drained at in an hour (from battery). Defaults
  to <em>1</em>1 kW.</li>
  <li><tt>msg.tg_max</tt> - The amount the grid can receive (to grid). Defaults to <em>1</em> kW.</em></li>
  <li><tt>msg.fg_max</tt> - The amount the grid can provide (from grid). Defaults to <em>1</em> kW.</em></li>
  <li><tt>msg.b_cost</tt> - Battery costs (per kWh for discharging or charging).</li>
  <li><tt>msg.provider_fee</tt> - The provider fee of buy/sell prices for the grid.</li>
  <li><tt>msg.vat_percentage</tt> - The VAT percentage (e.g. should be <code>1.21</code> for 21%)</li>
  <li><tt>msg.feed_in_possible</tt> - For overruling the configured value. Should be a boolean value.</li>
  <li><tt>msg.feed_in_control_on</tt> - For overruling the configured value. Should be a boolean value.</li>
  <li><tt>msg.url</tt> - <em>For debugging only.</em> This can be set to overrule the default VRM API url (<code>https://vrm-dynamic-ess-api.victronenergy.com</code></li>).
  </ul>

  <h3>Outputs</h3>

  <p>The first output sets the ESS setpoint as <code>msg.payload</code>. The second output gives more information for the coming 24 hours.</p>

  <p>The second output is for generating graphics.</p>

  <p>The third output can be used to disable _grid feed-in_ when the actual energy prices are
    below zero. When the prices are below zero, the output will be <tt>1</tt>, but only if the 
    configuration has been set to <i>Allow disable feed-in</i>. The output can be directly connected to an 
    <i>ESS control</i> node, set to "Disable feed-in".
    Alternatively you can use this output to steer your power hungry equipment.
  </p>

  <p>The fourth output gives some extra information when the API calls fails. It contains
    the error response of the API, usually consisting of <tt>status</tt>, <tt>statusText</tt>,
    <tt>headers</tt>, <tt>config</tt>, <tt>request</tt> and <tt>data</tt>.
  </p>

  <h3>Status</h3>

  <p>When everything works correctly, the node shows a green dot with the current ideal ESS setpoint.
    Else it shows a yellow dot containing the http statuscode. Connect a debug node to the fourth
    output for more information on what is happening.
  </p>

</script>
