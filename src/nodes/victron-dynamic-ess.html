<script type="text/javascript">
    RED.nodes.registerType('victron-dynamic-ess', {
        category: 'Victron Energy',
        paletteLabel: 'VRM dynamic ESS',
        color: '#f7ab3e',
        defaults: {
            name: { value: "" },
            site_id: { value: "", validate: RED.validators.regex(/^[a-z0-9]{1,12}$/) },
            vrmtoken: { value: "", validate: RED.validators.regex(/^[a-z0-9]{64}$/) },
            country: { value: "", validate: RED.validators.regex(/^[a-z]{2}[-()a-z0-9]*$/) },
            b_max: { value: 10, validate: RED.validators.number() },
            fb_max: { value: 1.1, validate: RED.validators.number() },
            tb_max: { value: 1.2, validate: RED.validators.number() },
            fg_max: { value: 1.0, validate: RED.validators.number() },
            tg_max: { value: 1.0, validate: RED.validators.number() },
            b_cost: { value: 0.0, validate: RED.validators.number() },
            buy_price_formula: { value: "p", validate: RED.validators.regex(/^[p0-9+-/*\.()]*$/) },
            sell_price_formula: { value: "p", validate: RED.validators.regex(/^[p0-9+-/*\.()]*$/) },
            feed_in_possible: { value: true },
            feed_in_control_on: { value: true },
            verbose: { value: false }
        },
        inputs: 1,
        outputs: 4,
        icon: "victronenergy.svg",
        label: function () {
            return this.name || "Dynamic ESS";
        },
        oneditprepare: function oneditprepare() {
            document.getElementById("node-input-sell_price_formula").disabled = ! $('input#node-input-feed_in_possible').is(':checked')
            $('input#node-input-feed_in_possible').on('click', function() {
                if ( $(this).is(':checked')) {
                    document.getElementById("node-input-tg_max").disabled = false
                    document.getElementById("node-input-sell_price_formula").disabled = false
                } else {
                    document.getElementById("node-input-tg_max").value = 0
                    document.getElementById("node-input-tg_max").disabled = true
                    document.getElementById("node-input-sell_price_formula").disabled = true
                }
            })
        },
        onadd: function() {
            let hasClient = false
            RED.nodes.eachConfig(function (n) {
                if (n.id === 'victron-client-id')
                    hasClient = true
            });

            if ( !hasClient ) {
                var victronClientNode = {
                    id: "victron-client-id",
                    _def: RED.nodes.getType("victron-client"),
                    type: "victron-client",
                    users: []
                };
                RED.nodes.add(victronClientNode);
                RED.nodes.dirty(true);
            }
        }
    });
</script>

<script type="text/html" data-template-name="victron-dynamic-ess">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-site_id"><i class="fa fa-id-card"></i> VRM site id</label>
        <input type="text" id="node-input-site_id" placeholder="VRM site id" required>
    </div>
    <div class="form-row">
        <label for="node-input-vrmtoken"><i class="fa fa-user-secret"></i> VRM token</label>
        <input type="password" id="node-input-vrmtoken" placeholder="VRM token" required>
    </div>
    <div class="form-row">
        <label for="node-input-country"><i class="fa fa-location-arrow"></i> Country / Energy region</label>
        <select id="node-input-country" required>
            <option value="at">Austria (at)</option>
            <option value="be">Belgium (be)</option>
            <option value="bg">Bulgaria (bg)</option>
            <option value="hr">Croatia (hr)</option>
            <option value="cz">Czech Republic (cz)</option>
            <option value="dk">Denmark (dk)</option>
            <option value="ee">Estonia (ee)</option>
            <option value="fi">Finland (fi)</option>
            <option value="fr">France (fr)</option>
            <option value="de">Germany (de)</option>
            <option value="gr">Greece (gr)</option>
            <option value="hu">Hungary (hu)</option>
            <option value="it-calabria">Italy - Calabria (it-calabria)</option>
            <option value="it-centre-north">Italy - Centre-North (it-centre-north)</option>
            <option value="it-centre-south">Italy - Centre-South (it-centre-south)</option>
            <option value="it-north">Italy - North (it-north)</option>
            <option value="it-sacoac">Italy - SACOAC (it-sacoac)</option>
            <option value="it-sadodc">Italy - SACODC (it-sacodc)</option>
            <option value="it-sardinia">Italy - Sardinia (it-sardinia)</option>
            <option value="it-sicily">Italy - Sicily (it-sicily)</option>
            <option value="it-south">Italy - South (it-south)</option>
            <option value="lv">Latvia (lv)</option>
            <option value="lt">Lithuania (lt)</option>
            <option value="lu">Luxembourg (lu)</option>
            <option value="me">Montenegro (me)</option>
            <option value="nl">Netherlands (nl)</option>
            <option value="mk">North Macedonia (mk)</option>
            <option value="no-1">Norway (no-1)</option>
            <option value="no-2">Norway (no-2)</option>
            <option value="no-2nsl">Norway (no-2nsl)</option>
            <option value="no-3">Norway (no-3)</option>
            <option value="no-4">Norway (no-4)</option>
            <option value="no-5">Norway (no-5)</option>
            <option value="pl">Poland (pl)</option>
            <option value="pt">Portugal (pt)</option>
            <option value="ro">Romania (ro)</option>
            <option value="rs">Serbia (rs)</option>
            <option value="sk">Slovakia (sk)</option>
            <option value="si">Slovenia (si)</option>
            <option value="es">Spain (es)</option>
            <option value="se-1">Sweden - SE1 (se-1)</option>
            <option value="se-2">Sweden - SE2 (se-2)</option>
            <option value="se-3">Sweden - SE3 (se-3)</option>
            <option value="se-4">Sweden - SE4 (se-4)</option>
            <option value="ch">Switzerland (ch)</option>
            <option value="ua-ips">Ukraine - IPS (ua-ips)</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-b_max"><i class="fa fa-battery-full"></i> B max</label>
        <input type="text" id="node-input-b_max" placeholder="Usable battery capacity (kWh)">
    </div>
    <div class="form-row">
        <label for="node-input-tb_max"><i class="fa fa-battery-full"></i> TB max</label>
        <input type="text" id="node-input-tb_max" placeholder="Amount the battery charges in one hour (kW)">
    </div>
    <div class="form-row">
        <label for="node-input-fb_max"><i class="fa fa-battery-full"></i> FB max</label>
        <input type="text" id="node-input-fb_max" placeholder="Amount the battery discharges in one hour (kW)">
    </div>
    <div class="form-row">
        <label for="node-input-tg_max"><i class="fa fa-battery-full"></i> TG max</label>
        <input type="text" id="node-input-tg_max" placeholder="Amount the grid can receive (to grid) in one hour (kW)">
    </div>
    <div class="form-row">
        <label for="node-input-fg_max"><i class="fa fa-battery-full"></i> FG max</label>
        <input type="text" id="node-input-fg_max" placeholder="Amount the grid can provide (from grid) in one hour (kW)">
    </div>
    <div class="form-row">
        <label for="node-input-b_cost"><i class="fa fa-money"></i> Battery costs</label>
        <input type="text" id="node-input-b_cost" placeholder="Battery costs">
    </div>
    <div class="form-row">
        <label for="node-input-buy_price_formula"><i class="fa fa-pencil"></i> Buy price</label>
        <input type="text" id="node-input-buy_price_formula" placeholder="The buy price formula">
    </div>
    <div class="form-row">
        <label for="node-input-sell_price_formula"><i class="fa fa-pencil"></i> Sell price</label>
        <input type="text" id="node-input-sell_price_formula" placeholder="The sell price formula">
    </div>
    <div class="form-row" style="margin-bottom:0px;">
        <input type="checkbox" checked id="node-input-feed_in_possible" style="display:inline-block; margin-left:8px; width:auto; vertical-align:top;">
        <label style="width: 70%" for="node-input-feed_in_possible"><i class="fa fa-power"></i> Feed in possible: Can you sell back to the grid?</label>
    </div>
    <div class="form-row" style="margin-bottom:0px;">
        <input type="checkbox" checked id="node-input-feed_in_control_on" style="display:inline-block; margin-left:8px; width:auto; vertical-align:top;">
        <label style="min-width:390px" for="node-input-feed_in_control_on"><i class="fa fa-power"></i> Feed-in control: Allow control over the feed-in variable (turn it off automatically when the prices are negative)?</label>
    </div>
    <div class="form-row" style="margin-bottom:0px;">
        <input type="checkbox" checked id="node-input-verbose" style="display:inline-block; margin-left:8px; width:auto; vertical-align:top;">
        <label style="min-width:390px" for="node-input-verbose"><i class="fa fa-power"></i> Verbose: show the used <tt>curl</tt> command in the debug tab?</label>
    </div>
</script>

<script type="text/markdown" data-help-name="victron-dynamic-ess">
A node that uses VRM forecasting and algorithm to optimize when to sell, buy and hold the grid to zero. 
See the [README](https://github.com/victronenergy/dynamic-ess/blob/main/README.md) on GitHub for the most up
to date documentation and a [QuickStart](https://github.com/victronenergy/dynamic-ess/blob/main/README.md#QuickStart).

### Inputs

: payload (string|number) :  the trigger to start (re-)calculating the optimal setpoint

Triggering the node to start working is not needed as the node will automatically fetch updated information with
a 12 minute interval after deployment.

### Outputs

1. Schedule current hour
: soc (number) : the scheduled SOC
: feed_in (boolean) : is grid feed in allowed
: duration (number) : duration in seconds for this schedule (always 3600)
: start (number) : unix timestamp on when to start this schedule (begining of current hour)

Output will be done on each whole hour (as a new schedules gets active then) and also every 12 minutes after deployment.
Notice that there is no `msg.payload` field.

### Configuration

: name (string) : The name of the node
: VRM site id (string | number) : The VRM id to fetch the data for. This is the unique number of the site and can be found in the url of your VRM dashboard.
: VRM token (string) : The VRM API token.
: Country (string) : The country code that is used for determining the hourly tarrif of the energy.
: B max (float) : Battery capacity (in kWh)
: TB max (float) : Maximum battery charge power (in kW) (**T**o **B**attery)
: FB max (float) : Maximum battery discharge power (in kW) (***F**rom **B**attery)
: TG max (float) : Maximum grid export power (in kW) (**T**o **G**rid)
: FG max (float) : Maximum grid import power (in kW) (**F**rom **G**rid)
: Battery costs (float) : Cost of charging or discharging the battery (in €/kWh)
: Buy price (string) : The buy price formula. The variable `p` represents the dynamic price / kWh.
: Sell price (string) : The sell price formula. The variable `p` represents the dynamic price / kWh.
: Feed-in possible (boolean) : Can you sell back to the grid?
: Feed-in control (boolean) : Allow control over the feed-in variable (turn it off automatically when the prices are negative)?
: Verbose (boolean) : Show the `curl` command in the debug tab?

See [here](https://github.com/victronenergy/dynamic-ess#create-an-access-token) for more information on creating an VRM access token.

Battery costs indicate how expensive it is to use it for charging and discharging, expressed in €/kWh. A typical calculation for this is:  
> costs for buying the battery in € / (charging cycles * battery capacity in kWh)

One battery charge cycle equals full battery charged to 100% and fully used to 0%. If you only use half of the battery power, then recharge it and repeat it the following day — it will also count as one charge cycle instead of two. The number of charging cycles is a number that differs per brand.  The battery costs is usually somewhere between € 0.02 and € 0.06 /kWh.  
Some feedback of users is that they don't care about the battery costs, as they already paid for it, so technically there's no additional costs to charge it. In that case we still advise to put a small amount in as battery costs. E.g. 0.01 €/kWh.

The buy formula looks typically something like: `(p+0.02+0.13)*1.21`. It this example it breaks down to:  
- p - the dynamic price / kWh
- € 0.02 - energy provider profit share
- € 0.13 - DSO working price + contributions/levy/taxes
- 21% - tax

The sell price formula looks often identical and in common cases looks something like `(p-0.02+0.13)*1.21`. So the energy provider profit share works the other way around.

### Details

For usage, please import the _fetch-dynamic-ess_ example and configure that. The complete example uses VRM forecasting and algorithm to optimize when to 
sell, buy and hold the grid to zero. For use in systems that have hourly  day ahead prices, such as is now available for a lot of consumers in Europe. 
There are several factors determining the optimal value, all being taken into account. These factors are:

- The VRM ID
- The solar prediction
- Your (dynamic) energy contract price
- Your battery size
- The charge speed of your battery
- The discharge speed of your battery
- Your predicted consumption
- The grid costs per kWh
- The battery costs per kWh
- Is grid feed-in possible
- Allow control over feed-in variable

If all of these values are known, VRM can make a calculated optimum setpoint available via its application programming interface (API). The dynamic
ess node utilizes that API to fetch it in a userfriendly way. Where optimum means the setting that should result in the lowest energy costs.

Some of the information is deducted from set parameters. Like the country determines the energy price (as retrieved from ENTSOE). The VRM location
determines the solar forecast. It uses solcast and the Global Horizontal Irradiance (GHI) for getting the predicted solar yield. So it is important
to set your location correctly in VRM.

`msg.payload` is used to trigger a (re)calculation of the optimal setpoint. As the VRM backend only updates every 5 minutes, there is no reason to
trigger this node more frequent.

It is also possible to overrule configuration settings via setting one of the following `msg` properties.

: site_id (number) :  The vrm id to fetch the data for. This is the unique number of the site and can be found in the url of the VRM dashboard.
: country (string) : The country code that is used for determining the hourly tarrif of the energy. See the dropdown in the select for the two-letter value to use.
: b_max (float) : This is the capacity the battery can hold in kWh.
: tb_max (float) : This is the speed in kW that the battery can be charged at in an hour (to battery).
: fb_max (float) : This is the speed in kW that the battery can be drained at in an hour (from battery).
: tg_max (float) : The amount the grid can receive (to grid).
: fg_max (float) : The amount the grid can provide (from grid).
: b_cost (float) : Battery costs (per kWh for discharging or charging).
: url (string) : _For debugging only_. This can be set to overrule the default VRM API url.

### Note

- This is a proof of concept project. In the future this implementation in Node-RED will become obsolete as the functionality will move into VRM/Venus OS native.
- This flow uses control paths that may interfere with your normal GX device usage. It adjusts settings (setpoint) and will insert a schedule for charging in the ESS menu. If you don't want that, don't use this node. See below which dbus paths are being used.
- When the API gets updated, there is a fair change that the node also needs to be updated. The API will respond with a 426 / Please update http status code.

### References

Please use either the issues on the GitHub site or the Node-RED space on our community for questions, troubleshooting and suggestions.
- [GitHub](https://github.com/victronenergy/dynamic-ess) - the nodes github repository
- [Community](https://community.victronenergy.com/smart-spaces/71/node-red.html) - Node-RED space in the Victron Energy community.

</script>

